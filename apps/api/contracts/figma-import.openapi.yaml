openapi: 3.0.3
info:
  title: QADMS Figma Token Import API
  version: 0.1.0
paths:
  /api/v1/sources/{source_id}/tokens/import/figma:
    post:
      summary: Import Figma/Tokens Studio token export
      operationId: postTokensImportFigma
      parameters:
        - in: path
          name: source_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
              description: Tokens Studio compatible JSON object or FigmaDMS theme-config JSON.
      responses:
        '200':
          description: Import succeeded and tokens were normalized.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportResponse'
        '400':
          description: Invalid request payload or path parameter.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '422':
          description: Import payload is syntactically valid JSON but fails token validation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportResponse'
        '500':
          description: Unexpected server error while processing import.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /api/v1/sources/{source_id}/audits/rules:
    post:
      summary: Run deterministic token rules and return violations
      operationId: postRuleAudit
      parameters:
        - in: path
          name: source_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
              description: Tokens Studio compatible JSON object or FigmaDMS theme-config JSON.
      responses:
        '200':
          description: Audit completed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleAuditResponse'
        '400':
          description: Invalid request payload or path parameter.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '500':
          description: Unexpected server error while running rule audit.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /api/v1/sources/{source_id}/audits/report:
    post:
      summary: Export rule audit report JSON
      operationId: postRuleReport
      parameters:
        - in: path
          name: source_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
              description: Tokens Studio compatible JSON object or FigmaDMS theme-config JSON.
      responses:
        '200':
          description: Report generated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleReportResponse'
        '400':
          description: Invalid request payload or path parameter.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '500':
          description: Unexpected server error while generating report.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
components:
  schemas:
    ErrorBody:
      type: object
      required: [code, message, details]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true
    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          $ref: '#/components/schemas/ErrorBody'
    ValidationIssue:
      type: object
      required: [path, message]
      properties:
        path:
          type: string
        message:
          type: string
    ValidationReport:
      type: object
      required: [valid, errors, warnings]
      properties:
        valid:
          type: boolean
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ValidationIssue'
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/ValidationIssue'
    CanonicalToken:
      type: object
      required: [group, path, name, token_type, value, source]
      properties:
        group:
          type: string
        path:
          type: string
        name:
          type: string
        token_type:
          type: string
        value: {}
        source:
          type: string
          enum: [figma_export]
    CanonicalTokenModel:
      type: object
      required: [source, tokens, token_counts]
      properties:
        source:
          type: string
          enum: [figma_export]
        tokens:
          type: array
          items:
            $ref: '#/components/schemas/CanonicalToken'
        token_counts:
          type: object
          additionalProperties:
            type: integer
    ImportResponse:
      type: object
      required: [source_id, version_id, imported_at, token_version, validation]
      properties:
        source_id:
          type: string
        version_id:
          type: string
        imported_at:
          type: string
          format: date-time
        token_version:
          $ref: '#/components/schemas/CanonicalTokenModel'
        validation:
          $ref: '#/components/schemas/ValidationReport'
    RuleAuditViolation:
      type: object
      required: [violation_id, rule_id, category, severity, code, title, description, evidence, fix_hint]
      properties:
        violation_id:
          type: string
        rule_id:
          type: string
        category:
          type: string
        severity:
          type: string
        code:
          type: string
        title:
          type: string
        description:
          type: string
        evidence:
          type: object
          additionalProperties: true
        fix_hint:
          type: object
          additionalProperties: true
    RuleAuditSummary:
      type: object
      required: [total_violations, by_severity, by_category, by_rule]
      properties:
        total_violations:
          type: integer
        by_severity:
          type: object
          additionalProperties:
            type: integer
        by_category:
          type: object
          additionalProperties:
            type: integer
        by_rule:
          type: object
          additionalProperties:
            type: integer
    RuleAuditNormalization:
      type: object
      required: [valid, error_count, warning_count]
      properties:
        valid:
          type: boolean
        error_count:
          type: integer
        warning_count:
          type: integer
    RuleAuditResponse:
      type: object
      required: [source_id, audit_id, evaluated_at, normalization, summary, violations]
      properties:
        source_id:
          type: string
        audit_id:
          type: string
        evaluated_at:
          type: string
          format: date-time
        normalization:
          $ref: '#/components/schemas/RuleAuditNormalization'
        summary:
          $ref: '#/components/schemas/RuleAuditSummary'
        violations:
          type: array
          items:
            $ref: '#/components/schemas/RuleAuditViolation'
    RuleReportResponse:
      type: object
      required: [source_id, audit_id, generated_at, summary, violations]
      properties:
        source_id:
          type: string
        audit_id:
          type: string
        generated_at:
          type: string
          format: date-time
        summary:
          $ref: '#/components/schemas/RuleAuditSummary'
        violations:
          type: array
          items:
            $ref: '#/components/schemas/RuleAuditViolation'

name: Deploy Scaffold

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      deploy_api:
        description: "Deploy API service"
        required: true
        default: true
        type: boolean
      deploy_web:
        description: "Deploy web service"
        required: true
        default: true
        type: boolean
      dry_run:
        description: "Skip provider deployment commands (recommended until infra is wired)"
        required: true
        default: true
        type: boolean

concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.meta.outputs.environment }}
      deploy_api: ${{ steps.meta.outputs.deploy_api }}
      deploy_web: ${{ steps.meta.outputs.deploy_web }}
      dry_run: ${{ steps.meta.outputs.dry_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve deploy metadata
        id: meta
        run: |
          echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
          echo "deploy_api=${{ github.event.inputs.deploy_api }}" >> "$GITHUB_OUTPUT"
          echo "deploy_web=${{ github.event.inputs.deploy_web }}" >> "$GITHUB_OUTPUT"
          echo "dry_run=${{ github.event.inputs.dry_run }}" >> "$GITHUB_OUTPUT"

      - name: Deploy summary
        run: |
          echo "Deploy scaffold triggered."
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Deploy API:  ${{ github.event.inputs.deploy_api }}"
          echo "Deploy Web:  ${{ github.event.inputs.deploy_web }}"
          echo "Dry run:     ${{ github.event.inputs.dry_run }}"

  build-api:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.deploy_api == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install API dependencies
        run: python -m pip install --upgrade pip && pip install -r apps/api/requirements.txt

      - name: Run API tests
        run: python -m unittest -v

      - name: Build API artifact (scaffold)
        run: |
          mkdir -p dist/api
          cp -R apps/api dist/api/apps_api
          cp -R packages dist/api/packages
          echo "api-artifact-built=true" > dist/api/metadata.txt

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-artifact
          path: dist/api

  build-web:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.deploy_web == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "apps/web/package-lock.json"

      - name: Install and build web
        working-directory: apps/web
        run: npm ci && npm run test:ci && npm run build

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-artifact
          path: apps/web/.next

  deploy:
    runs-on: ubuntu-latest
    needs: [preflight, build-api, build-web]
    if: always() && needs.preflight.result == 'success'
    steps:
      - name: Download API artifact
        if: needs.preflight.outputs.deploy_api == 'true'
        uses: actions/download-artifact@v4
        with:
          name: api-artifact
          path: dist/api

      - name: Download web artifact
        if: needs.preflight.outputs.deploy_web == 'true'
        uses: actions/download-artifact@v4
        with:
          name: web-artifact
          path: dist/web

      - name: Dry run deployment summary
        if: needs.preflight.outputs.dry_run == 'true'
        run: |
          echo "Dry run enabled. No cloud provider deployment commands executed."
          echo "Next step: replace this block with provider CLI deploy commands."

      - name: Deploy placeholder
        if: needs.preflight.outputs.dry_run != 'true'
        run: |
          echo "Real deployment is not wired yet."
          echo "Integrate provider auth + CLI in this job."
          exit 1
